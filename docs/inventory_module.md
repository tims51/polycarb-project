# 成品库存管理模块 (Inventory Module) 文档

## 1. 模块概述
库存管理模块是聚羧酸研发管理系统的核心子系统，负责管理成品（如母液、速凝剂等）的入库、出库、盘点及查询分析。

### 主要特性
- **实时监控**: 通过仪表盘实时查看库存总量及分布。
- **预警机制**: 当单一产品库存低于 10 吨时自动触发警报。
- **全流程追溯**: 强制要求入库必须关联生产批号，出库必须关联客户信息。
- **数据一致性**: 采用“双重保障”机制（实时快照 + 流水账），并提供盘点校准功能。

---

## 2. API 接口文档 (InventoryService)

核心业务逻辑封装在 `app/services/inventory_service.py` 中。

### 2.1 获取库存概览
`get_inventory_summary(low_stock_threshold=10.0)`
- **功能**: 返回用于仪表盘展示的统计数据。
- **参数**:
    - `low_stock_threshold` (float): 低库存阈值，默认 10.0。
- **返回**: Dict (总库存, 产品数, 预警列表, 分布DataFrame)。

### 2.2 生产入库
`process_inbound(product_name, product_type, quantity, batch_number, operator, date_str)`
- **功能**: 处理生产完工入库。
- **验证**:
    - 数量必须 > 0。
    - **必须提供生产批号**。
- **返回**: (Success, Message)。

### 2.3 销售出库
`process_outbound(product_name, quantity, customer, remark, operator, date_str)`
- **功能**: 处理销售或领用出库。
- **验证**:
    - 检查当前库存是否充足。
- **返回**: (Success, Message)。

### 2.4 库存校准
`calibrate_stock(product_name, actual_stock, reason_note, operator)`
- **功能**: 处理盘盈盘亏。
- **逻辑**: 计算 `Diff = 实盘 - 账面`，自动生成 `adjust_in` 或 `adjust_out` 记录。

---

## 3. 用户操作手册

### 3.1 查看库存监控
1. 进入“成品库存”页面。
2. 默认显示“监控看板”标签页。
3. 查看顶部的 KPI 卡片了解总库存。
4. 如有红色警告条，表示有产品急需补货。

### 3.2 办理入库
1. 切换到“库存操作”标签页。
2. 选择“生产入库”。
3. 选择产品（或输入新产品名）。
4. 输入数量和**生产批号** (如 `PROD-20240120-01`)。
5. 点击“确认入库”。

### 3.3 办理出库
1. 切换到“库存操作”标签页。
2. 选择“销售出库”。
3. 选择产品（系统会自动显示当前可用库存）。
4. 输入数量和客户名称。
5. 点击“确认出库”。

### 3.4 查询与导出
1. 切换到“明细查询”标签页。
2. 设置时间范围或产品类型筛选。
3. 表格显示结果后，点击下方的“📥 导出查询结果 (CSV)”按钮下载 Excel 可读文件。

---

## 4. 部署与维护

### 4.1 数据备份
系统已配置自动备份机制。所有库存变更都会实时写入 `data.json`，同时系统会自动维护 `backups/` 目录下的历史版本（每小时一次差异备份，保留最近30个版本）。

### 4.2 性能说明
当前设计基于 JSON 文件存储，经基准测试（2026-01-20）：
- **读取延迟**: < 10ms (极快)
- **写入延迟**: ~10ms/条 (单条记录)
- **批量处理**: 100条记录约 1.0s (支持每秒约100次并发写入)
- **容量建议**: 支持约 10万条流水记录的秒级查询。如数据量进一步增长，建议迁移至 SQLite 或 PostgreSQL 数据库。
