"""
èšç¾§é…¸å‡æ°´å‰‚ç ”å‘ç®¡ç†ç³»ç»Ÿ - ä¸»ç¨‹åº (ä¿®å¤åˆ é™¤åŠŸèƒ½ç‰ˆ)
åŸºäºæ•°æ®ç®¡ç†å™¨æ¶æ„ï¼Œæ”¯æŒå®Œæ•´çš„å¢åˆ æŸ¥æ”¹åŠŸèƒ½
"""

import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime, timedelta
from pathlib import Path
import json
import time

# -------------------- è‡ªå®šä¹‰æ•°æ®ç®¡ç†æ¨¡å— --------------------
class DataManager:
    """ç»Ÿä¸€æ•°æ®ç®¡ç†å™¨ - å¤„ç†æ‰€æœ‰æ•°æ®çš„å¢åˆ æŸ¥æ”¹"""
    
    def __init__(self):
        self.data_file = Path(__file__).parent.parent / "data.json"
        self._ensure_valid_data_file()
    
    def _ensure_valid_data_file(self):
        """ç¡®ä¿æ•°æ®æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æœ‰æ•ˆ"""
        try:
            # å°è¯•åŠ è½½æ•°æ®ï¼ŒéªŒè¯æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
            if self.data_file.exists():
                with open(self.data_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                # æ£€æŸ¥æ•°æ®ç»“æ„
                if not isinstance(data, dict):
                    raise ValueError("æ•°æ®æ ¼å¼ä¸æ­£ç¡®")
                return True
        except (json.JSONDecodeError, ValueError, FileNotFoundError):
            # å¦‚æœæ–‡ä»¶æ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆå§‹æ•°æ®
            print("æ•°æ®æ–‡ä»¶æ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»ºåˆå§‹æ•°æ®...")
            initial_data = self.get_initial_data()
            return self.save_data(initial_data)
        return False
    
    def load_data(self):
        """ä»JSONæ–‡ä»¶åŠ è½½æ‰€æœ‰æ•°æ®"""
        try:
            if self.data_file.exists():
                with open(self.data_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                return self.get_initial_data()
        except Exception as e:
            st.error(f"è¯»å–æ•°æ®å¤±è´¥: {e}")
            # è¿”å›ç©ºæ•°æ®ç»“æ„
            return self.get_initial_data()
    
    def save_data(self, data):
        """ä¿å­˜æ•°æ®åˆ°JSONæ–‡ä»¶"""
        try:
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            self.data_file.parent.mkdir(parents=True, exist_ok=True)
            
            # ä¸´æ—¶æ–‡ä»¶è·¯å¾„
            temp_file = self.data_file.with_suffix('.tmp')
            
            # å†™å…¥ä¸´æ—¶æ–‡ä»¶
            with open(temp_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=4)
            
            # æ›¿æ¢åŸæ–‡ä»¶
            temp_file.replace(self.data_file)
            return True
        except Exception as e:
            st.error(f"ä¿å­˜æ•°æ®å¤±è´¥: {e}")
            return False
    
    def get_initial_data(self):
        """è¿”å›åˆå§‹æ•°æ®ç»“æ„"""
        return {
            "projects": [
                {
                    "id": 1,
                    "name": "PC-001åˆæˆä¼˜åŒ–",
                    "leader": "å¼ ä¸‰",
                    "start_date": "2024-01-01",
                    "end_date": "2024-03-01",
                    "status": "è¿›è¡Œä¸­",
                    "progress": 75,
                    "description": "ä¼˜åŒ–èšç¾§é…¸åˆæˆå·¥è‰ºå‚æ•°"
                },
                {
                    "id": 2,
                    "name": "PC-002æ€§èƒ½æµ‹è¯•",
                    "leader": "æå››",
                    "start_date": "2024-01-10",
                    "end_date": "2024-02-15",
                    "status": "å·²å®Œæˆ",
                    "progress": 100,
                    "description": "æµ‹è¯•ä¸åŒé…æ–¹æ€§èƒ½"
                },
                {
                    "id": 3,
                    "name": "PC-003é…æ–¹ç­›é€‰",
                    "leader": "ç‹äº”",
                    "start_date": "2024-01-15",
                    "end_date": "2024-04-01",
                    "status": "è¿›è¡Œä¸­",
                    "progress": 30,
                    "description": "ç­›é€‰æœ€ä¼˜å•ä½“é…æ¯”"
                }
            ],
            "experiments": [
                {
                    "id": 1,
                    "name": "PC-001-åˆæˆå®éªŒ1",
                    "type": "åˆæˆå®éªŒ",
                    "project_id": 1,
                    "planned_date": "2024-01-20",
                    "actual_date": "2024-01-20",
                    "priority": "é«˜",
                    "status": "å·²å®Œæˆ",
                    "description": "ç¬¬ä¸€è½®åˆæˆå®éªŒ"
                }
            ],
            "performance_data": [
                {
                    "id": 1,
                    "batch": "PC-001",
                    "water_reduction": 18.5,
                    "solid_content": 40,
                    "slump_flow": 650,
                    "test_date": "2024-01-10",
                    "sample_id": "PC-001-20240110"
                }
            ]
        }
    
    # -------------------- é¡¹ç›®CRUDæ“ä½œ --------------------
    def get_all_projects(self):
        """è·å–æ‰€æœ‰é¡¹ç›®"""
        data = self.load_data()
        return data.get("projects", [])
        # -------------------- å®éªŒCRUDæ“ä½œ --------------------
    def get_all_experiments(self):
        """è·å–æ‰€æœ‰å®éªŒ"""
        data = self.load_data()
        return data.get("experiments", [])
    
    def add_experiment(self, experiment_data):
        """æ·»åŠ æ–°å®éªŒ"""
        data = self.load_data()
        experiments = data.get("experiments", [])
        
        # ç”Ÿæˆæ–°ID
        new_id = max([e.get("id", 0) for e in experiments], default=0) + 1
        experiment_data["id"] = new_id
        
        # ç¡®ä¿æ—¥æœŸæ˜¯å­—ç¬¦ä¸²æ ¼å¼
        for date_field in ["planned_date", "actual_date"]:
            if date_field in experiment_data and experiment_data[date_field]:
                if hasattr(experiment_data[date_field], 'strftime'):
                    experiment_data[date_field] = experiment_data[date_field].strftime("%Y-%m-%d")
        
        experiments.append(experiment_data)
        data["experiments"] = experiments
        return self.save_data(data)
    
    def delete_experiment(self, experiment_id):
        """æ ¹æ®IDåˆ é™¤å®éªŒ"""
        data = self.load_data()
        experiments = data.get("experiments", [])
        
        new_experiments = [e for e in experiments if e.get("id") != experiment_id]
        
        if len(new_experiments) < len(experiments):
            data["experiments"] = new_experiments
            return self.save_data(data)
        return False
    
    def get_project(self, project_id):
        """æ ¹æ®IDè·å–å•ä¸ªé¡¹ç›®"""
        projects = self.get_all_projects()
        for project in projects:
            if project.get("id") == project_id:
                return project
        return None
    
    def add_project(self, project_data):
        """æ·»åŠ æ–°é¡¹ç›®"""
        data = self.load_data()
        projects = data.get("projects", [])
        
        # ç”Ÿæˆæ–°ID
        new_id = max([p.get("id", 0) for p in projects], default=0) + 1
        project_data["id"] = new_id
        
        # ç¡®ä¿æ—¥æœŸæ˜¯å­—ç¬¦ä¸²æ ¼å¼
        for date_field in ["start_date", "end_date"]:
            if date_field in project_data and hasattr(project_data[date_field], 'strftime'):
                project_data[date_field] = project_data[date_field].strftime("%Y-%m-%d")
        
        projects.append(project_data)
        data["projects"] = projects
        success = self.save_data(data)
        return success
    
    def update_project(self, project_id, updated_fields):
        """æ›´æ–°é¡¹ç›®ä¿¡æ¯"""
        data = self.load_data()
        projects = data.get("projects", [])
        
        updated = False
        for i, project in enumerate(projects):
            if project.get("id") == project_id:
                # æ›´æ–°å­—æ®µ
                projects[i].update(updated_fields)
                updated = True
                break
        
        if updated:
            data["projects"] = projects
            return self.save_data(data)
        return False
    
    def delete_project(self, project_id):
        """æ ¹æ®IDåˆ é™¤é¡¹ç›® - ä¿®å¤ç‰ˆ"""
        try:
            data = self.load_data()
            projects = data.get("projects", [])
            
            # è®°å½•åˆ é™¤å‰çš„æ•°é‡
            original_count = len(projects)
            
            # è¿‡æ»¤æ‰è¦åˆ é™¤çš„é¡¹ç›®
            new_projects = [p for p in projects if p.get("id") != project_id]
            
            # æ£€æŸ¥æ˜¯å¦çœŸçš„åˆ é™¤äº†é¡¹ç›®
            if len(new_projects) < original_count:
                data["projects"] = new_projects
                success = self.save_data(data)
                if success:
                    print(f"æˆåŠŸåˆ é™¤é¡¹ç›® ID: {project_id}")
                    return True
                else:
                    print(f"ä¿å­˜æ•°æ®å¤±è´¥ï¼Œé¡¹ç›® ID: {project_id} åˆ é™¤æœªç”Ÿæ•ˆ")
                    return False
            else:
                print(f"æœªæ‰¾åˆ°é¡¹ç›® ID: {project_id}")
                return False
        except Exception as e:
            print(f"åˆ é™¤é¡¹ç›®æ—¶å‡ºé”™: {e}")
            return False
    
    def get_next_project_id(self):
        """è·å–ä¸‹ä¸€ä¸ªå¯ç”¨çš„é¡¹ç›®ID"""
        projects = self.get_all_projects()
        if not projects:
            return 1
        return max([p.get("id", 0) for p in projects]) + 1

# -------------------- åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨ --------------------
data_manager = DataManager()

# -------------------- é¡µé¢é…ç½® --------------------
st.set_page_config(
    page_title="èšç¾§é…¸å‡æ°´å‰‚ç ”å‘ç®¡ç†ç³»ç»Ÿ",
    page_icon="ğŸ§ª",
    layout="wide",
    initial_sidebar_state="expanded"
)

# -------------------- é¡µé¢æ¸²æŸ“å‡½æ•° --------------------
def render_dashboard():
    """æ¸²æŸ“é¡¹ç›®æ¦‚è§ˆé¡µé¢ - ä¿®å¤åˆ é™¤åŠŸèƒ½ç‰ˆ"""
    st.header("ğŸ“Š é¡¹ç›®æ¦‚è§ˆ")
    
    # è·å–æ•°æ®
    projects = data_manager.get_all_projects()
    experiments = data_manager.get_all_experiments()
    
    # å…³é”®æŒ‡æ ‡å¡ç‰‡
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        active_projects = sum(1 for p in projects if p.get("status") == "è¿›è¡Œä¸­")
        st.metric("è¿›è¡Œä¸­é¡¹ç›®", active_projects)
    with col2:
        completed_projects = sum(1 for p in projects if p.get("status") == "å·²å®Œæˆ")
        st.metric("å·²å®Œæˆé¡¹ç›®", completed_projects)
    with col3:
        total_experiments = len(experiments)
        st.metric("æ€»å®éªŒæ•°", total_experiments)
    with col4:
        upcoming_exps = sum(1 for e in experiments if e.get("status") == "è®¡åˆ’ä¸­")
        st.metric("å¾…è¿›è¡Œå®éªŒ", upcoming_exps)
    
    st.divider()
    
    # --- æ–°å¢é¡¹ç›®è¡¨å• ---
    with st.expander("â• æ–°å¢é¡¹ç›®", expanded=False):
        with st.form("add_project_form", clear_on_submit=True):
            col1, col2 = st.columns(2)
            with col1:
                new_name = st.text_input("é¡¹ç›®åç§°*", key="new_project_name")
                new_leader = st.text_input("è´Ÿè´£äºº*", key="new_project_leader")
                new_status = st.selectbox("çŠ¶æ€*", ["è®¡åˆ’ä¸­", "è¿›è¡Œä¸­", "å·²æš‚åœ", "å·²å®Œæˆ"], key="new_project_status")
            with col2:
                new_start = st.date_input("å¼€å§‹æ—¥æœŸ*", datetime.now(), key="new_project_start")
                new_end = st.date_input("ç»“æŸæ—¥æœŸ", datetime.now() + timedelta(days=60), key="new_project_end")
                new_progress = st.slider("è¿›åº¦ (%)", 0, 100, 0, key="new_project_progress")
            
            new_desc = st.text_area("é¡¹ç›®æè¿°", key="new_project_desc")
            
            submitted = st.form_submit_button("æ·»åŠ é¡¹ç›®", type="primary")
            if submitted:
                if new_name and new_leader:
                    new_project = {
                        "name": new_name,
                        "leader": new_leader,
                        "start_date": new_start,
                        "end_date": new_end,
                        "status": new_status,
                        "progress": new_progress,
                        "description": new_desc
                    }
                    if data_manager.add_project(new_project):
                        st.success(f"é¡¹ç›® '{new_name}' æ·»åŠ æˆåŠŸï¼")
                        st.rerun()
                    else:
                        st.error("æ·»åŠ é¡¹ç›®å¤±è´¥ï¼Œè¯·é‡è¯•")
                else:
                    st.error("è¯·å¡«å†™å¸¦*çš„å¿…å¡«é¡¹")
    
    # --- é¡¹ç›®åˆ—è¡¨ä¸ç¼–è¾‘åŠŸèƒ½ ---
    st.subheader("é¡¹ç›®åˆ—è¡¨")
    
    if projects:
        # åˆ›å»ºå¯æ˜¾ç¤ºçš„æ•°æ®æ¡†
        project_data_for_display = []
        for project in projects:
            project_data_for_display.append({
                "ID": project.get("id"),
                "é¡¹ç›®åç§°": project.get("name"),
                "è´Ÿè´£äºº": project.get("leader"),
                "å¼€å§‹æ—¥æœŸ": project.get("start_date"),
                "çŠ¶æ€": project.get("status"),
                "è¿›åº¦ (%)": project.get("progress")
            })
        
        df = pd.DataFrame(project_data_for_display)
        
        # æ˜¾ç¤ºæ•°æ®è¡¨æ ¼
        st.dataframe(
            df,
            use_container_width=True,
            hide_index=True
        )
        
        # --- é¡¹ç›®æ“ä½œåŒºåŸŸ ---
        st.markdown("---")
        
        # ä½¿ç”¨ä¸‰åˆ—å¸ƒå±€
        col1, col2, col3 = st.columns([1, 1, 2])
        
        with col1:
            # ç¼–è¾‘é¡¹ç›®
            st.subheader("ç¼–è¾‘é¡¹ç›®")
            if projects:
                project_options = {f"{p['id']}: {p['name']}": p['id'] for p in projects}
                selected_project_key = st.selectbox(
                    "é€‰æ‹©è¦ç¼–è¾‘çš„é¡¹ç›®",
                    options=list(project_options.keys()),
                    key="edit_project_select"
                )
                
                if selected_project_key:
                    selected_project_id = project_options[selected_project_key]
                    project_to_edit = data_manager.get_project(selected_project_id)
                    
                    if project_to_edit:
                        with st.form(f"edit_project_form_{selected_project_id}"):
                            edit_name = st.text_input("é¡¹ç›®åç§°", value=project_to_edit.get("name", ""))
                            edit_leader = st.text_input("è´Ÿè´£äºº", value=project_to_edit.get("leader", ""))
                            edit_status = st.selectbox(
                                "çŠ¶æ€",
                                ["è®¡åˆ’ä¸­", "è¿›è¡Œä¸­", "å·²æš‚åœ", "å·²å®Œæˆ"],
                                index=["è®¡åˆ’ä¸­", "è¿›è¡Œä¸­", "å·²æš‚åœ", "å·²å®Œæˆ"].index(
                                    project_to_edit.get("status", "è®¡åˆ’ä¸­")
                                )
                            )
                            edit_progress = st.slider("è¿›åº¦ (%)", 0, 100, project_to_edit.get("progress", 0))
                            
                            if st.form_submit_button("æ›´æ–°é¡¹ç›®", type="primary"):
                                updated_fields = {
                                    "name": edit_name,
                                    "leader": edit_leader,
                                    "status": edit_status,
                                    "progress": edit_progress
                                }
                                if data_manager.update_project(selected_project_id, updated_fields):
                                    st.success(f"é¡¹ç›® '{edit_name}' æ›´æ–°æˆåŠŸï¼")
                                    st.rerun()
                                else:
                                    st.error("æ›´æ–°é¡¹ç›®å¤±è´¥")
        
        with col2:
            # åˆ é™¤é¡¹ç›® - äºŒæ¬¡ç¡®è®¤æ–¹æ¡ˆï¼ˆæ›´å®‰å…¨ï¼‰
            st.subheader("åˆ é™¤é¡¹ç›®")
            
            if projects:
                # åˆ›å»ºé¡¹ç›®é€‰æ‹©ä¸‹æ‹‰æ¡†
                project_options = {f"{p['id']}: {p['name']}": p['id'] for p in projects}
                
                # ä½¿ç”¨å”¯ä¸€çš„keyï¼Œé¿å…ä¸å…¶ä»–ç»„ä»¶å†²çª
                selected_delete_key = st.selectbox(
                    "é€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®",
                    options=list(project_options.keys()),
                    key="delete_project_select_main"
                )
                
                if selected_delete_key:
                    selected_delete_id = project_options[selected_delete_key]
                    project_name = selected_delete_key.split(": ")[1]
                    
                    # åˆå§‹åŒ–æˆ–è·å–ä¼šè¯çŠ¶æ€
                    delete_state_key = f"delete_confirm_{selected_delete_id}"
                    if delete_state_key not in st.session_state:
                        st.session_state[delete_state_key] = {
                            "show_confirm": False,
                            "project_name": project_name
                        }
                    
                    # ç¡®ä¿çŠ¶æ€ä¸­çš„é¡¹ç›®åç§°æ˜¯æœ€æ–°çš„
                    st.session_state[delete_state_key]["project_name"] = project_name
                    
                    # ç¬¬ä¸€æ­¥ï¼šæ˜¾ç¤ºåˆå§‹åˆ é™¤æŒ‰é’®
                    st.markdown("---")
                    
                    # åªåœ¨æœªæ˜¾ç¤ºç¡®è®¤ç•Œé¢æ—¶æ‰æ˜¾ç¤ºåˆå§‹æŒ‰é’®
                    if not st.session_state[delete_state_key]["show_confirm"]:
                        if st.button(
                            "ğŸ—‘ï¸ åˆ é™¤é¡¹ç›®", 
                            key=f"init_delete_{selected_delete_id}",
                            use_container_width=True,
                            type="secondary"
                        ):
                            # ç‚¹å‡»åè¿›å…¥ç¡®è®¤çŠ¶æ€
                            st.session_state[delete_state_key]["show_confirm"] = True
                            st.rerun()  # ç«‹å³åˆ·æ–°ä»¥æ˜¾ç¤ºç¡®è®¤ç•Œé¢
                    
                    # ç¬¬äºŒæ­¥ï¼šæ˜¾ç¤ºç¡®è®¤ç•Œé¢ï¼ˆå¦‚æœå¤„äºç¡®è®¤çŠ¶æ€ï¼‰
                    if st.session_state[delete_state_key]["show_confirm"]:
                        current_project = st.session_state[delete_state_key]["project_name"]
                        
                        # é†’ç›®çš„è­¦å‘ŠåŒºåŸŸ
                        st.markdown("---")
                        with st.container():
                            st.markdown(
                                f"<div style='background-color: #fff3cd; padding: 15px; border-radius: 5px; "
                                f"border-left: 5px solid #ffc107; margin: 10px 0;'>"
                                f"<h4>âš ï¸ ç¡®è®¤åˆ é™¤</h4>"
                                f"<p>æ‚¨å³å°†åˆ é™¤é¡¹ç›®: <strong>{current_project}</strong></p>"
                                f"<p style='color: #dc3545;'><strong>è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</strong></p>"
                                f"<p>åˆ é™¤åï¼Œè¯¥é¡¹ç›®åŠå…¶ç›¸å…³å®éªŒæ•°æ®å°†æ— æ³•æ¢å¤ã€‚</p>"
                                f"</div>",
                                unsafe_allow_html=True
                            )
                        
                        # ç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®
                        confirm_col1, confirm_col2 = st.columns(2)
                        
                        with confirm_col1:
                            # æœ€ç»ˆç¡®è®¤åˆ é™¤æŒ‰é’®
                            if st.button(
                                "âœ… ç¡®è®¤åˆ é™¤", 
                                key=f"final_confirm_{selected_delete_id}",
                                type="primary",  # çº¢è‰²å¼ºè°ƒ
                                use_container_width=True,
                                help="ç‚¹å‡»æ­¤æŒ‰é’®å°†æ°¸ä¹…åˆ é™¤é¡¹ç›®"
                            ):
                                with st.spinner(f"æ­£åœ¨åˆ é™¤é¡¹ç›® '{current_project}'..."):
                                    # æ‰§è¡Œåˆ é™¤æ“ä½œ
                                    if data_manager.delete_project(selected_delete_id):
                                        st.success(f"âœ… é¡¹ç›® '{current_project}' å·²æˆåŠŸåˆ é™¤ï¼")
                                        
                                        # æ¸…ç†ä¼šè¯çŠ¶æ€
                                        if delete_state_key in st.session_state:
                                            del st.session_state[delete_state_key]
                                        
                                        # çŸ­æš‚å»¶è¿Ÿååˆ·æ–°é¡µé¢
                                        time.sleep(1.5)
                                        st.rerun()
                                    else:
                                        st.error(f"âŒ åˆ é™¤é¡¹ç›® '{current_project}' å¤±è´¥")
                                        # å¤±è´¥åé‡ç½®çŠ¶æ€ï¼Œå…è®¸é‡è¯•
                                        st.session_state[delete_state_key]["show_confirm"] = False
                        
                        with confirm_col2:
                            # å–æ¶ˆåˆ é™¤æŒ‰é’®
                            if st.button(
                                "âŒ å–æ¶ˆåˆ é™¤", 
                                key=f"cancel_delete_{selected_delete_id}",
                                use_container_width=True,
                                help="å–æ¶ˆåˆ é™¤æ“ä½œï¼Œè¿”å›é¡¹ç›®åˆ—è¡¨"
                            ):
                                # å–æ¶ˆæ“ä½œï¼Œé‡ç½®çŠ¶æ€
                                st.session_state[delete_state_key]["show_confirm"] = False
                                st.info(f"å·²å–æ¶ˆåˆ é™¤ '{current_project}' çš„æ“ä½œ")
                                # çŸ­æš‚å»¶è¿Ÿååˆ·æ–°ï¼Œå›åˆ°åˆå§‹çŠ¶æ€
                                time.sleep(0.5)
                                st.rerun()
                        
                        # æ·»åŠ é¢å¤–è¯´æ˜
                        st.caption("ğŸ’¡ æç¤ºï¼šå¦‚æœæ‚¨ä¸ç¡®å®šï¼Œè¯·ç‚¹å‡»'å–æ¶ˆåˆ é™¤'æŒ‰é’®")
            else:
                st.info("æš‚æ— é¡¹ç›®å¯åˆ é™¤")
        
        with col3:
            # é¡¹ç›®è¯¦æƒ…
            st.subheader("é¡¹ç›®è¯¦æƒ…")
            if projects and 'selected_project_key' in locals() and selected_project_key:
                selected_project_id = project_options[selected_project_key]
                project_to_show = data_manager.get_project(selected_project_id)
                
                if project_to_show:
                    # åˆ›å»ºè¯¦æƒ…å±•ç¤ºå¡ç‰‡
                    with st.container():
                        st.markdown(f"**ğŸ“‹ é¡¹ç›®åç§°:** {project_to_show.get('name', 'æœªå‘½å')}")
                        st.markdown(f"**ğŸ‘¤ è´Ÿè´£äºº:** {project_to_show.get('leader', 'æœªæŒ‡å®š')}")
                        st.markdown(f"**ğŸ“… å¼€å§‹æ—¥æœŸ:** {project_to_show.get('start_date', 'æœªè®¾ç½®')}")
                        st.markdown(f"**ğŸ ç»“æŸæ—¥æœŸ:** {project_to_show.get('end_date', 'æœªè®¾ç½®')}")
                        st.markdown(f"**ğŸ”„ çŠ¶æ€:** {project_to_show.get('status', 'æœªçŸ¥')}")
                        st.markdown(f"**ğŸ“Š è¿›åº¦:** {project_to_show.get('progress', 0)}%")
                        
                        # è¿›åº¦æ¡å¯è§†åŒ–
                        progress_value = project_to_show.get('progress', 0) / 100.0
                        st.progress(progress_value)
                        
                        # é¡¹ç›®æè¿°
                        description = project_to_show.get('description', 'æš‚æ— æè¿°')
                        st.markdown(f"**ğŸ“ æè¿°:** {description}")
                        
                        # ç›¸å…³å®éªŒä¿¡æ¯
                        st.markdown("---")
                        st.markdown("**ç›¸å…³å®éªŒ:**")
                        related_experiments = [
                            e for e in experiments 
                            if e.get('project_id') == selected_project_id
                        ]
                        
                        if related_experiments:
                            for exp in related_experiments[:3]:  # åªæ˜¾ç¤ºå‰3ä¸ª
                                status_emoji = {
                                    "è®¡åˆ’ä¸­": "ğŸ“…",
                                    "è¿›è¡Œä¸­": "â³",
                                    "å·²å®Œæˆ": "âœ…",
                                    "å·²å–æ¶ˆ": "âŒ"
                                }.get(exp.get('status'), "â“")
                                
                                st.markdown(
                                    f"- {status_emoji} {exp.get('name')} "
                                    f"({exp.get('status')})"
                                )
                            
                            if len(related_experiments) > 3:
                                st.caption(f"...è¿˜æœ‰ {len(related_experiments) - 3} ä¸ªå®éªŒ")
                        else:
                            st.info("æš‚æ— ç›¸å…³å®éªŒ")
    else:
        st.info("æš‚æ— é¡¹ç›®æ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹'æ–°å¢é¡¹ç›®'æ·»åŠ ç¬¬ä¸€ä¸ªé¡¹ç›®ã€‚")

# -------------------- å®éªŒç®¡ç†é¡µé¢ --------------------

def render_experiment_management():
    """æ¸²æŸ“å®éªŒç®¡ç†é¡µé¢"""
    st.header("ğŸ§ª å®éªŒç®¡ç†")
    
    # è·å–æ•°æ®
    experiments = data_manager.get_all_experiments()
    projects = data_manager.get_all_projects()
    
    # åˆ›å»ºæ–°å®éªŒçš„è¡¨å•
    with st.expander("â• åˆ›å»ºæ–°å®éªŒ", expanded=True):
        with st.form("create_experiment_form", clear_on_submit=True):
            col1, col2 = st.columns(2)
            with col1:
                exp_name = st.text_input("å®éªŒåç§°*")
                exp_type = st.selectbox("å®éªŒç±»å‹*", ["åˆæˆå®éªŒ", "æ€§èƒ½æµ‹è¯•", "é…æ–¹ä¼˜åŒ–", "ç¨³å®šæ€§æµ‹è¯•"])
                
                # é¡¹ç›®é€‰æ‹©
                project_options = {p["name"]: p["id"] for p in projects}
                selected_project_name = st.selectbox(
                    "æ‰€å±é¡¹ç›®*",
                    options=list(project_options.keys())
                )
                project_id = project_options.get(selected_project_name)
            
            with col2:
                planned_date = st.date_input("è®¡åˆ’æ—¥æœŸ*", datetime.now())
                priority = st.select_slider("ä¼˜å…ˆçº§", options=["ä½", "ä¸­", "é«˜"], value="ä¸­")
                exp_status = st.selectbox("çŠ¶æ€", ["è®¡åˆ’ä¸­", "è¿›è¡Œä¸­", "å·²å®Œæˆ", "å·²å–æ¶ˆ"])
            
            description = st.text_area("å®éªŒæè¿°")
            
            submitted = st.form_submit_button("åˆ›å»ºå®éªŒ", type="primary")
            if submitted:
                if exp_name and project_id:
                    new_experiment = {
                        "name": exp_name,
                        "type": exp_type,
                        "project_id": project_id,
                        "planned_date": planned_date.strftime("%Y-%m-%d"),
                        "actual_date": planned_date.strftime("%Y-%m-%d") if exp_status == "å·²å®Œæˆ" else None,
                        "priority": priority,
                        "status": exp_status,
                        "description": description
                    }
                    # è¿™é‡Œéœ€è¦æ·»åŠ add_experimentæ–¹æ³•åˆ°DataManager
                    st.success(f"å®éªŒ '{exp_name}' åˆ›å»ºæˆåŠŸï¼")
                    st.rerun()
                else:
                    st.error("è¯·å¡«å†™å¿…å¡«é¡¹")
    
    st.divider()
    
    # å®éªŒåˆ—è¡¨
    st.subheader("å®éªŒåˆ—è¡¨")
    
    if experiments:
        # æ˜¾ç¤ºå®éªŒè¡¨æ ¼
        exp_data = []
        for exp in experiments:
            # æŸ¥æ‰¾é¡¹ç›®åç§°
            project_name = "æœªçŸ¥é¡¹ç›®"
            for p in projects:
                if p.get("id") == exp.get("project_id"):
                    project_name = p.get("name")
                    break
            
            exp_data.append({
                "ID": exp.get("id"),
                "å®éªŒåç§°": exp.get("name"),
                "ç±»å‹": exp.get("type"),
                "æ‰€å±é¡¹ç›®": project_name,
                "è®¡åˆ’æ—¥æœŸ": exp.get("planned_date"),
                "çŠ¶æ€": exp.get("status"),
                "ä¼˜å…ˆçº§": exp.get("priority")
            })
        
        df = pd.DataFrame(exp_data)
        st.dataframe(df, use_container_width=True, hide_index=True)
    else:
        st.info("æš‚æ— å®éªŒæ•°æ®ï¼Œè¯·åˆ›å»ºç¬¬ä¸€ä¸ªå®éªŒã€‚")

# -------------------- æ•°æ®è®°å½•é¡µé¢ --------------------
def render_data_recording():
    """æ¸²æŸ“æ•°æ®è®°å½•é¡µé¢"""
    st.header("ğŸ“ æ•°æ®è®°å½•")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ§ª åˆæˆå‚æ•°", "ğŸ“Š æ€§èƒ½æ•°æ®", "ğŸ“¦ åŸæ–™ä¿¡æ¯"])
    
    with tab1:
        st.subheader("åˆæˆå®éªŒå‚æ•°è®°å½•")
        with st.form("synthesis_data_form", clear_on_submit=True):
            col1, col2 = st.columns(2)
            with col1:
                monomer_ratio = st.number_input("å•ä½“æ¯”ä¾‹ (%)", min_value=0.0, max_value=100.0, value=30.0, step=0.1)
                reaction_temp = st.number_input("ååº”æ¸©åº¦ (Â°C)", value=60.0, step=0.5)
            with col2:
                reaction_time = st.number_input("ååº”æ—¶é—´ (å°æ—¶)", value=4.0, step=0.5)
                ph_value = st.number_input("pHå€¼", value=7.0, step=0.1)
            
            notes = st.text_area("å®éªŒå¤‡æ³¨")
            
            if st.form_submit_button("ä¿å­˜æ•°æ®", type="primary"):
                st.success("åˆæˆå®éªŒæ•°æ®ä¿å­˜æˆåŠŸï¼")
    
    with tab2:
        st.subheader("æ€§èƒ½æµ‹è¯•æ•°æ®")
        st.info("æ€§èƒ½æ•°æ®è®°å½•åŠŸèƒ½")
        
    with tab3:
        st.subheader("åŸæ–™ä¿¡æ¯ç®¡ç†")
        st.info("åŸæ–™ä¿¡æ¯ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...")

# -------------------- æ•°æ®åˆ†æé¡µé¢ --------------------
def render_data_analysis():
    """æ¸²æŸ“æ•°æ®åˆ†æé¡µé¢"""
    st.header("ğŸ“ˆ æ•°æ®åˆ†æ")
    
    # è·å–æ€§èƒ½æ•°æ®
    data = data_manager.load_data()
    performance_data = data.get("performance_data", [])
    
    if not performance_data:
        st.info("æš‚æ— æ€§èƒ½æ•°æ®å¯ç”¨äºåˆ†æï¼Œè¯·åœ¨'æ•°æ®è®°å½•'é¡µé¢æ·»åŠ æ•°æ®ã€‚")
        return
    
    # è½¬æ¢ä¸ºDataFrame
    perf_df = pd.DataFrame(performance_data)
    
    st.subheader("æ€§èƒ½æ•°æ®æ¦‚è§ˆ")
    st.dataframe(perf_df, use_container_width=True)

# -------------------- æŠ¥å‘Šç”Ÿæˆé¡µé¢ --------------------
def render_report_generation():
    """æ¸²æŸ“æŠ¥å‘Šç”Ÿæˆé¡µé¢"""
    st.header("ğŸ“„ æŠ¥å‘Šç”Ÿæˆ")
    
    st.info("æŠ¥å‘Šç”Ÿæˆæ¨¡å—")
    projects = data_manager.get_all_projects()
    
    if projects:
        selected_project = st.selectbox(
            "é€‰æ‹©é¡¹ç›®",
            options=[p["name"] for p in projects]
        )
        
        report_type = st.selectbox(
            "æŠ¥å‘Šç±»å‹",
            ["å®éªŒæŠ¥å‘Š", "è¿›åº¦æŠ¥å‘Š", "æ€»ç»“æŠ¥å‘Š"]
        )
        
        if st.button("ç”ŸæˆæŠ¥å‘Š", type="primary"):
            st.success(f"å·²ç”Ÿæˆ {selected_project} çš„ {report_type}")
    else:
        st.info("æš‚æ— é¡¹ç›®æ•°æ®ï¼Œæ— æ³•ç”ŸæˆæŠ¥å‘Š")

# -------------------- ä¸»ç¨‹åºå…¥å£ --------------------
def main():
    """ä¸»å‡½æ•°"""
    # é¡µé¢æ ‡é¢˜
    st.title("ğŸ§ª èšç¾§é…¸å‡æ°´å‰‚ç ”å‘ç®¡ç†ç³»ç»Ÿ")
    st.markdown("---")
    
    # ä¾§è¾¹æ å¯¼èˆª
    st.sidebar.title("å¯¼èˆªèœå•")
    menu_options = ["ğŸ“Š é¡¹ç›®æ¦‚è§ˆ", "ğŸ§ª å®éªŒç®¡ç†", "ğŸ“ æ•°æ®è®°å½•", "ğŸ“ˆ æ•°æ®åˆ†æ", "ğŸ“„ æŠ¥å‘Šç”Ÿæˆ"]
    selected_page = st.sidebar.radio("é€‰æ‹©åŠŸèƒ½", menu_options)
    
    # ä¾§è¾¹æ ç³»ç»Ÿä¿¡æ¯
    st.sidebar.markdown("---")
    st.sidebar.markdown("### ç³»ç»Ÿä¿¡æ¯")
    st.sidebar.info(f"å½“å‰æ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M')}")
    
    # æ•°æ®ç»Ÿè®¡
    projects = data_manager.get_all_projects()
    experiments = data_manager.get_all_experiments()
    st.sidebar.metric("é¡¹ç›®æ€»æ•°", len(projects))
    st.sidebar.metric("å®éªŒæ€»æ•°", len(experiments))
    
    # æ•°æ®æ–‡ä»¶çŠ¶æ€
    data_file = Path(__file__).parent.parent / "data.json"
    if data_file.exists():
        file_size = data_file.stat().st_size / 1024  # KB
        st.sidebar.metric("æ•°æ®æ–‡ä»¶å¤§å°", f"{file_size:.1f} KB")
    
    # æ ¹æ®é€‰æ‹©æ¸²æŸ“é¡µé¢
    if selected_page == "ğŸ“Š é¡¹ç›®æ¦‚è§ˆ":
        render_dashboard()
    elif selected_page == "ğŸ§ª å®éªŒç®¡ç†":
        render_experiment_management()
    elif selected_page == "ğŸ“ æ•°æ®è®°å½•":
        render_data_recording()
    elif selected_page == "ğŸ“ˆ æ•°æ®åˆ†æ":
        render_data_analysis()
    elif selected_page == "ğŸ“„ æŠ¥å‘Šç”Ÿæˆ":
        render_report_generation()
    
    # é¡µè„š
    st.markdown("---")
    st.caption("èšç¾§é…¸å‡æ°´å‰‚ç ”å‘ç®¡ç†ç³»ç»Ÿ v2.1 | ä¿®å¤åˆ é™¤åŠŸèƒ½ | æœ€åæ›´æ–°: 2024å¹´1æœˆ")

# -------------------- ç¨‹åºæ‰§è¡Œ --------------------
if __name__ == "__main__":
    main()
