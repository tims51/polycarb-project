# -------------------- æ•°æ®è®°å½•é¡µé¢ --------------------
def render_data_recording():
    """æ¸²æŸ“æ•°æ®è®°å½•é¡µé¢ - é‡æ„ç‰ˆï¼Œåˆ†ä¸ºå››ä¸ªåŠŸèƒ½æ¨¡å—"""
    st.header("ğŸ“ æ•°æ®è®°å½•")
    
    # ä½¿ç”¨é€‰é¡¹å¡åˆ†ä¸ºå››ä¸ªåŠŸèƒ½æ¨¡å—
    tab1, tab2, tab3, tab4 = st.tabs(["ğŸ§ª åˆæˆå®éªŒ", "ğŸ¥£ å‡€æµ†å®éªŒ", "ğŸ—ï¸ ç ‚æµ†å®éªŒ", "ğŸ¢ æ··å‡åœŸå®éªŒ"])
    
    # è·å–å®éªŒé¡¹ç›®å’Œå®éªŒæ•°æ®
    experiments = data_manager.get_all_experiments()
    projects = data_manager.get_all_projects()
    data = data_manager.load_data()
    
    # åˆå§‹åŒ–æ•°æ®å­˜å‚¨ç»“æ„
    if "performance_data" not in data:
        data["performance_data"] = {
            "synthesis": [],
            "paste": [],
            "mortar": [],
            "concrete": []
        }
    
    # è¾…åŠ©å‡½æ•°ï¼šè·å–å®éªŒé€‰é¡¹
    def get_experiment_options(exp_type=None):
        """æ ¹æ®å®éªŒç±»å‹è·å–å®éªŒé€‰é¡¹"""
        options = {}
        for exp in experiments:
            if exp_type and exp.get("type") != exp_type:
                continue
            # æŸ¥æ‰¾é¡¹ç›®åç§°
            project_name = "æœªçŸ¥é¡¹ç›®"
            for proj in projects:
                if proj.get("id") == exp.get("project_id"):
                    project_name = proj.get("name", "æœªçŸ¥é¡¹ç›®")
                    break
            # ä½¿ç”¨å®éªŒIDå’Œåç§°ä½œä¸ºé€‰é¡¹
            exp_key = f"{exp['id']}: {exp['name']} - {project_name}"
            options[exp_key] = exp['id']
        return options
    
   # 1. åˆæˆå®éªŒæ•°æ®è®°å½• - é‡å¤§ä¿®æ”¹
    with tab1:
        st.subheader("ğŸ§ª åˆæˆå®éªŒæ•°æ®è®°å½•")
        
        # åˆ›å»ºä¸‰åˆ—å¸ƒå±€
        col1, col2, col3 = st.columns([1, 1, 1])
        
        with col1:
            # å®éªŒé€‰æ‹©
            exp_options = get_experiment_options("åˆæˆå®éªŒ")
            if exp_options:
                selected_exp_key = st.selectbox(
                    "é€‰æ‹©å®éªŒé¡¹ç›®*",
                    options=list(exp_options.keys()),
                    key="synthesis_exp_select"
                )
                selected_exp_id = exp_options.get(selected_exp_key)
            else:
                st.warning("æš‚æ— åˆæˆå®éªŒé¡¹ç›®ï¼Œè¯·åœ¨å®éªŒç®¡ç†ä¸­åˆ›å»º")
                selected_exp_id = None
            
            # åŸºç¡€ä¿¡æ¯
            with st.container(border=True):
                st.markdown("### åŸºç¡€ä¿¡æ¯")
                record_date = st.date_input("è®°å½•æ—¥æœŸ*", datetime.now(), key="synthesis_date")
                operator = st.text_input("æ“ä½œäºº*", value="å¾æ¢“é¦¨", key="synthesis_operator")
                batch_no = st.text_input("æ‰¹æ¬¡å·*", placeholder="ä¾‹å¦‚: SYN-20240106-001", key="synthesis_batch")
                formula_id = st.text_input("é…æ–¹ç¼–å·", placeholder="ä¾‹å¦‚: F-001", key="synthesis_formula")
        
        with col2:
            # æ€§èƒ½æŒ‡æ ‡ - å¢åŠ é¢œè‰²æŒ‡æ ‡
            with st.container(border=True):
                st.markdown("### æ€§èƒ½æŒ‡æ ‡")
                col_metric1, col_metric2 = st.columns(2)
                with col_metric1:
                    water_reduction = st.number_input("å‡æ°´ç‡ (%)", min_value=0.0, max_value=100.0, value=18.5, step=0.1, key="synthesis_water_reduction")
                    solid_content = st.number_input("å›ºå«é‡ (%)", min_value=0.0, max_value=100.0, value=40.0, step=0.1, key="synthesis_solid")
                    ph_value = st.number_input("pHå€¼", min_value=0.0, max_value=14.0, value=7.0, step=0.1, key="synthesis_ph")
                
                with col_metric2:
                    density = st.number_input("å¯†åº¦ (g/cmÂ³)", min_value=0.0, max_value=2.0, value=1.05, step=0.01, key="synthesis_density")
                    viscosity = st.number_input("ç²˜åº¦ (mPaÂ·s)", min_value=0.0, max_value=10000.0, value=50.0, step=1.0, key="synthesis_viscosity")
                    stability = st.selectbox("ç¨³å®šæ€§", ["ä¼˜è‰¯", "è‰¯å¥½", "ä¸€èˆ¬", "è¾ƒå·®"], key="synthesis_stability")
                    color = st.text_input("é¢œè‰²", placeholder="ä¾‹å¦‚: æ·¡é»„è‰²", key="synthesis_color")
        
        with col3:
            # ååº”æ¡ä»¶
            with st.container(border=True):
                st.markdown("### ååº”æ¡ä»¶")
                reaction_temp = st.number_input("ååº”æ¸©åº¦ (Â°C)", min_value=0.0, max_value=200.0, value=60.0, step=0.5, key="synthesis_temp")
                reaction_time = st.number_input("ååº”æ—¶é—´ (å°æ—¶)", min_value=0.0, max_value=24.0, value=4.0, step=0.5, key="synthesis_time")
                nitrogen_time = st.number_input("æ°®æ°”ä¿æŠ¤æ—¶é—´ (åˆ†é’Ÿ)", min_value=0, max_value=120, value=30, step=5, key="synthesis_nitrogen")
        
        # ==================== åˆæˆå·¥è‰ºå‚æ•° ====================
        # 1. ååº”é‡œéƒ¨åˆ†
        with st.expander("âš™ï¸ ååº”é‡œéƒ¨åˆ†", expanded=True):
            st.markdown("#### ååº”é‡œç‰©æ–™")
            
            col_reactor1, col_reactor2, col_reactor3, col_reactor4 = st.columns(4)
            
            with col_reactor1:
                big_monomer = st.number_input("å¤§å•ä½“ (g)", min_value=0.0, value=100.0, step=1.0, key="big_monomer")
                small_monomer1 = st.number_input("å°å•ä½“1 (g)", min_value=0.0, value=20.0, step=1.0, key="small_monomer1")
            
            with col_reactor2:
                small_monomer2 = st.number_input("å°å•ä½“2 (g)", min_value=0.0, value=15.0, step=1.0, key="small_monomer2")
                small_monomer3 = st.number_input("å°å•ä½“3 (g)", min_value=0.0, value=10.0, step=1.0, key="small_monomer3")
            
            with col_reactor3:
                catalyst = st.number_input("å‚¬åŒ–å‰‚ (g)", min_value=0.0, value=1.0, step=0.1, key="catalyst")
                chain_transfer1 = st.number_input("é“¾è½¬ç§»å‰‚1 (g)", min_value=0.0, value=0.5, step=0.1, key="chain_transfer1")
            
            with col_reactor4:
                initiator1 = st.number_input("å¼•å‘å‰‚ (g)", min_value=0.0, value=0.2, step=0.1, key="initiator1")
                water1 = st.number_input("æ°´ (g)", min_value=0.0, value=200.0, step=1.0, key="water1")
            
            # æ»´åŠ æ§åˆ¶å‚æ•°
            st.markdown("#### æ»´åŠ æ§åˆ¶å‚æ•°")
            col_drop1, col_drop2 = st.columns(2)
            
            with col_drop1:
                drop_start_temp = st.number_input("æ»´åŠ èµ·å§‹æ¸©åº¦ (Â°C)", min_value=0.0, max_value=200.0, value=60.0, step=0.5, key="drop_start_temp")
                max_temp_limit = st.number_input("æœ€é«˜æ¸©åº¦é™åˆ¶ (Â°C)", min_value=0.0, max_value=200.0, value=80.0, step=0.5, key="max_temp_limit")
            
            with col_drop2:
                drop_time_A = st.number_input("Aæ–™æ»´åŠ æ—¶é—´ (min)", min_value=0, max_value=300, value=120, step=5, key="drop_time_A")
                drop_time_B = st.number_input("Bæ–™æ»´åŠ æ—¶é—´ (min)", min_value=0, max_value=300, value=180, step=5, key="drop_time_B")
        
        # 2. Aæ–™éƒ¨åˆ†
        with st.expander("ğŸ”¬ Aæ–™éƒ¨åˆ†", expanded=False):
            st.markdown("#### Aæ–™ç»„æˆ")
            
            col_A1, col_A2, col_A3 = st.columns(3)
            
            with col_A1:
                monomer1_A = st.number_input("å•ä½“1 (g)", min_value=0.0, value=30.0, step=1.0, key="monomer1_A")
                monomer2_A = st.number_input("å•ä½“2 (g)", min_value=0.0, value=25.0, step=1.0, key="monomer2_A")
            
            with col_A2:
                monomer3_A = st.number_input("å•ä½“3 (g)", min_value=0.0, value=20.0, step=1.0, key="monomer3_A")
                monomer4_A = st.number_input("å•ä½“4 (g)", min_value=0.0, value=15.0, step=1.0, key="monomer4_A")
            
            with col_A3:
                water_A = st.number_input("æ°´ (g)", min_value=0.0, value=100.0, step=1.0, key="water_A")
            
            # è®¡ç®—Aæ–™æ€»é‡å’Œæ»´åŠ é€Ÿåº¦
            total_A = monomer1_A + monomer2_A + monomer3_A + monomer4_A + water_A
            drop_speed_A = total_A / drop_time_A if drop_time_A > 0 else 0
            
            col_calc1, col_calc2 = st.columns(2)
            with col_calc1:
                st.metric("Aæ–™æ€»è´¨é‡ (g)", f"{total_A:.1f}")
            with col_calc2:
                st.metric("Aæ–™æ»´åŠ é€Ÿåº¦ (g/min)", f"{drop_speed_A:.1f}")
        
        # 3. Bæ–™éƒ¨åˆ†
        with st.expander("ğŸ”¬ Bæ–™éƒ¨åˆ†", expanded=False):
            st.markdown("#### Bæ–™ç»„æˆ")
            
            col_B1, col_B2, col_B3 = st.columns(3)
            
            with col_B1:
                initiator2_B = st.number_input("å¼•å‘å‰‚2 (g)", min_value=0.0, value=0.5, step=0.1, key="initiator2_B")
                chain_transfer2_B = st.number_input("é“¾è½¬ç§»å‰‚2 (g)", min_value=0.0, value=0.3, step=0.1, key="chain_transfer2_B")
            
            with col_B2:
                other1_B = st.number_input("å…¶ä»–ç‰©æ–™1 (g)", min_value=0.0, value=1.0, step=0.1, key="other1_B")
                other2_B = st.number_input("å…¶ä»–ç‰©æ–™2 (g)", min_value=0.0, value=1.0, step=0.1, key="other2_B")
            
            with col_B3:
                water_B = st.number_input("æ°´ (g)", min_value=0.0, value=50.0, step=1.0, key="water_B")
            
            # è®¡ç®—Bæ–™æ€»é‡å’Œæ»´åŠ é€Ÿåº¦
            total_B = initiator2_B + chain_transfer2_B + other1_B + other2_B + water_B
            drop_speed_B = total_B / drop_time_B if drop_time_B > 0 else 0
            
            col_calc1, col_calc2 = st.columns(2)
            with col_calc1:
                st.metric("Bæ–™æ€»è´¨é‡ (g)", f"{total_B:.1f}")
            with col_calc2:
                st.metric("Bæ–™æ»´åŠ é€Ÿåº¦ (g/min)", f"{drop_speed_B:.1f}")
        
        # ==================== æˆå“å‡æ°´å‰‚æ¨¡å— ====================
        with st.expander("ğŸ“¦ æˆå“å‡æ°´å‰‚", expanded=False):
            st.markdown("### æˆå“å‡æ°´å‰‚ä¿¡æ¯")
            
            col_product1, col_product2 = st.columns(2)
            
            with col_product1:
                product_name = st.text_input("äº§å“åç§°", placeholder="ä¾‹å¦‚: PC-100", key="product_name")
                product_batch = st.text_input("æˆå“æ‰¹æ¬¡å·", placeholder="ä¾‹å¦‚: PC-100-20240106", key="product_batch")
                production_date = st.date_input("ç”Ÿäº§æ—¥æœŸ", datetime.now(), key="production_date")
                package_type = st.selectbox("åŒ…è£…å½¢å¼", ["æ¡¶è£…", "è¢‹è£…", "æ¶²è¢‹", "å…¶ä»–"], key="package_type")
            
            with col_product2:
                product_solid = st.number_input("æˆå“å›ºå«é‡ (%)", min_value=0.0, max_value=100.0, value=40.0, step=0.1, key="product_solid")
                product_ph = st.number_input("æˆå“pHå€¼", min_value=0.0, max_value=14.0, value=7.0, step=0.1, key="product_ph")
                product_density = st.number_input("æˆå“å¯†åº¦ (g/cmÂ³)", min_value=0.0, max_value=2.0, value=1.05, step=0.01, key="product_density")
                product_color = st.text_input("æˆå“é¢œè‰²", placeholder="ä¾‹å¦‚: æ·¡é»„è‰²é€æ˜", key="product_color")
        
        # å¤‡æ³¨å’Œä¿å­˜
        col_note, col_save = st.columns([3, 1])
        with col_note:
            notes = st.text_area("å®éªŒå¤‡æ³¨", height=100, placeholder="è®°å½•å®éªŒç°è±¡ã€å¼‚å¸¸æƒ…å†µã€æ”¹è¿›å»ºè®®ç­‰", key="synthesis_notes")
        
        with col_save:
            st.markdown("<br>" * 4, unsafe_allow_html=True)
            if st.button("ğŸ’¾ ä¿å­˜åˆæˆå®éªŒæ•°æ®", type="primary", use_container_width=True, key="save_synthesis"):
                if selected_exp_id and batch_no and operator:
                    # æ„å»ºåˆæˆå®éªŒæ•°æ®
                    synthesis_data = {
                        "id": str(uuid.uuid4())[:8],
                        "experiment_id": selected_exp_id,
                        "record_date": record_date.strftime("%Y-%m-%d"),
                        "operator": operator,
                        "batch_no": batch_no,
                        "formula_id": formula_id,
                        
                        # æ€§èƒ½æŒ‡æ ‡
                        "water_reduction": water_reduction,
                        "solid_content": solid_content,
                        "ph_value": ph_value,
                        "density": density,
                        "viscosity": viscosity,
                        "stability": stability,
                        "color": color,
                        
                        # ååº”æ¡ä»¶
                        "reaction_temp": reaction_temp,
                        "reaction_time": reaction_time,
                        "nitrogen_time": nitrogen_time,
                        
                        # ååº”é‡œéƒ¨åˆ†
                        "big_monomer": big_monomer,
                        "small_monomer1": small_monomer1,
                        "small_monomer2": small_monomer2,
                        "small_monomer3": small_monomer3,
                        "catalyst": catalyst,
                        "chain_transfer1": chain_transfer1,
                        "initiator1": initiator1,
                        "water1": water1,
                        "drop_start_temp": drop_start_temp,
                        "max_temp_limit": max_temp_limit,
                        
                        # Aæ–™éƒ¨åˆ†
                        "monomer1_A": monomer1_A,
                        "monomer2_A": monomer2_A,
                        "monomer3_A": monomer3_A,
                        "monomer4_A": monomer4_A,
                        "water_A": water_A,
                        "drop_time_A": drop_time_A,
                        "drop_speed_A": drop_speed_A,
                        "total_A": total_A,
                        
                        # Bæ–™éƒ¨åˆ†
                        "initiator2_B": initiator2_B,
                        "chain_transfer2_B": chain_transfer2_B,
                        "other1_B": other1_B,
                        "other2_B": other2_B,
                        "water_B": water_B,
                        "drop_time_B": drop_time_B,
                        "drop_speed_B": drop_speed_B,
                        "total_B": total_B,
                        
                        # å¤‡æ³¨
                        "notes": notes,
                        
                        # å…ƒæ•°æ®
                        "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "type": "synthesis"
                    }
                    
                    # ä¿å­˜åˆæˆå®éªŒæ•°æ®
                    if data_manager.add_synthesis_record(synthesis_data):
                        st.success("âœ… åˆæˆå®éªŒæ•°æ®ä¿å­˜æˆåŠŸï¼")
                        
                        # å¦‚æœå¡«å†™äº†æˆå“å‡æ°´å‰‚ä¿¡æ¯ï¼Œä¹Ÿä¿å­˜æˆå“æ•°æ®
                        if product_name and product_batch:
                            product_data = {
                                "product_name": product_name,
                                "batch_no": product_batch,
                                "production_date": production_date.strftime("%Y-%m-%d"),
                                "package_type": package_type,
                                "solid_content": product_solid,
                                "ph_value": product_ph,
                                "density": product_density,
                                "color": product_color,
                                "parent_batch": batch_no,  # å…³è”æ¯æ¶²æ‰¹æ¬¡
                                "synthesis_record_id": synthesis_data["id"],
                                "experiment_id": selected_exp_id,
                                "operator": operator
                            }
                            
                            if data_manager.add_product(product_data):
                                st.success("âœ… æˆå“å‡æ°´å‰‚ä¿¡æ¯ä¿å­˜æˆåŠŸï¼")
                        
                        time.sleep(1)
                        st.rerun()
                    else:
                        st.error("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")
                else:
                    st.error("è¯·å¡«å†™å¸¦*çš„å¿…å¡«é¡¹")
    
    # 2. å‡€æµ†å®éªŒæ•°æ®è®°å½• - ä¿®æ”¹ä¸ºå…³è”æ¯æ¶²æˆ–æˆå“
    with tab2:
        st.subheader("ğŸ¥£ å‡€æµ†å®éªŒæ•°æ®è®°å½•")
        
        # åˆ›å»ºä¸¤åˆ—å¸ƒå±€
        col1, col2 = st.columns([1, 1])
        
        with col1:
            # å®éªŒé€‰æ‹©
            exp_options = get_experiment_options("æ€§èƒ½æµ‹è¯•")
            if exp_options:
                selected_exp_key = st.selectbox(
                    "é€‰æ‹©å®éªŒé¡¹ç›®*",
                    options=list(exp_options.keys()),
                    key="paste_exp_select"
                )
                selected_exp_id = exp_options.get(selected_exp_key)
            else:
                st.warning("æš‚æ— æ€§èƒ½æµ‹è¯•å®éªŒé¡¹ç›®ï¼Œè¯·åœ¨å®éªŒç®¡ç†ä¸­åˆ›å»º")
                selected_exp_id = None
            
            # å…³è”æ‰¹æ¬¡é€‰æ‹©
            with st.container(border=True):
                st.markdown("### å…³è”æ‰¹æ¬¡")
                
                # è·å–æ‰€æœ‰æ‰¹æ¬¡é€‰é¡¹
                batch_options = data_manager.get_all_batch_options()
                
                if batch_options:
                    batch_option_names = [f"{b['name']} ({b['date']})" for b in batch_options]
                    selected_batch_name = st.selectbox(
                        "é€‰æ‹©å…³è”æ‰¹æ¬¡*",
                        options=batch_option_names,
                        key="paste_batch_select"
                    )
                    
                    if selected_batch_name:
                        selected_index = batch_option_names.index(selected_batch_name)
                        selected_batch = batch_options[selected_index]
                        batch_type = selected_batch["type"]
                        batch_no = selected_batch["batch_no"]
                        batch_source = selected_batch["source"]
                        batch_source_id = selected_batch["source_id"]
                        
                        st.info(f"å·²é€‰æ‹©: {batch_type} - {batch_no}")
                else:
                    st.warning("æš‚æ— å¯ç”¨æ‰¹æ¬¡ï¼Œè¯·å…ˆè¿›è¡Œåˆæˆå®éªŒ")
                    batch_type = None
                    batch_no = None
                    batch_source = None
                    batch_source_id = None
            
            # åŸºç¡€ä¿¡æ¯
            with st.container(border=True):
                st.markdown("### åŸºç¡€ä¿¡æ¯")
                record_date = st.date_input("è®°å½•æ—¥æœŸ*", datetime.now(), key="paste_date")
                operator = st.text_input("æ“ä½œäºº*", value="å¾æ¢“é¦¨", key="paste_operator")
                sample_id = st.text_input("æ ·å“ç¼–å·*", placeholder="ä¾‹å¦‚: PASTE-001", key="paste_sample")
        
        with col2:
            # å®éªŒæ¡ä»¶
            with st.container(border=True):
                st.markdown("### å®éªŒæ¡ä»¶")
                col_cond1, col_cond2 = st.columns(2)
                with col_cond1:
                    cement_type = st.selectbox("æ°´æ³¥ç±»å‹*", ["PÂ·O 42.5", "PÂ·O 52.5", "PÂ·II 42.5", "å…¶ä»–"], key="paste_cement")
                    water_cement_ratio = st.number_input("æ°´ç°æ¯”*", min_value=0.1, max_value=1.0, value=0.29, step=0.01, key="paste_wc")
                
                with col_cond2:
                    admixture_dosage = st.number_input("å‡æ°´å‰‚æºé‡ (%)*", min_value=0.0, max_value=5.0, value=0.18, step=0.01, key="paste_dosage")
                    temperature = st.number_input("ç¯å¢ƒæ¸©åº¦ (Â°C)", value=20.0, step=0.5, key="paste_temp")
        
        # ... å…¶ä½™å‡€æµ†å®éªŒæ•°æ®è®°å½•ä»£ç ä¿æŒä¸å˜ï¼Œåªéœ€åœ¨ä¿å­˜æ—¶æ·»åŠ å…³è”æ‰¹æ¬¡ä¿¡æ¯ ...
        
        # åœ¨ä¿å­˜å‡€æµ†å®éªŒæ•°æ®æ—¶ï¼Œæ·»åŠ å…³è”æ‰¹æ¬¡ä¿¡æ¯
        if st.button("ğŸ’¾ ä¿å­˜å‡€æµ†å®éªŒæ•°æ®", type="primary", use_container_width=True, key="save_paste"):
            if selected_exp_id and sample_id and operator and cement_type and batch_no:
                # æ„å»ºæ•°æ®è®°å½•ï¼Œæ·»åŠ å…³è”ä¿¡æ¯
                paste_data = {
                    # ... åŸæœ‰å­—æ®µ ...
                    "related_batch_type": batch_type,
                    "related_batch_no": batch_no,
                    "related_batch_source": batch_source,
                    "related_batch_id": batch_source_id,
                    # ... å…¶ä½™å­—æ®µ ...
                }
    
    # 2. å‡€æµ†å®éªŒæ•°æ®è®°å½•
    with tab2:
        st.subheader("ğŸ¥£ å‡€æµ†å®éªŒæ•°æ®è®°å½•")
        
        # åˆ›å»ºä¸¤åˆ—å¸ƒå±€
        col1, col2 = st.columns([1, 1])
        
        with col1:
            # å®éªŒé€‰æ‹©
            exp_options = get_experiment_options("æ€§èƒ½æµ‹è¯•")
            if exp_options:
                selected_exp_key = st.selectbox(
                    "é€‰æ‹©å®éªŒé¡¹ç›®",
                    options=list(exp_options.keys()),
                    key="paste_exp_select"
                )
                selected_exp_id = exp_options.get(selected_exp_key)
            else:
                st.warning("æš‚æ— æ€§èƒ½æµ‹è¯•å®éªŒé¡¹ç›®ï¼Œè¯·åœ¨å®éªŒç®¡ç†ä¸­åˆ›å»º")
                selected_exp_id = None
            
            # åŸºç¡€ä¿¡æ¯
            with st.container(border=True):
                st.markdown("### åŸºç¡€ä¿¡æ¯")
                record_date = st.date_input("è®°å½•æ—¥æœŸ", datetime.now(), key="paste_date")
                operator = st.text_input("æ“ä½œäºº", value="å¾æ¢“é¦¨", key="paste_operator")
                sample_id = st.text_input("æ ·å“ç¼–å·", placeholder="ä¾‹å¦‚: PASTE-001", key="paste_sample")
        
        with col2:
            # å®éªŒæ¡ä»¶
            with st.container(border=True):
                st.markdown("### å®éªŒæ¡ä»¶")
                col_cond1, col_cond2 = st.columns(2)
                with col_cond1:
                    cement_type = st.selectbox("æ°´æ³¥ç±»å‹", ["PÂ·O 42.5", "PÂ·O 52.5", "PÂ·II 42.5", "å…¶ä»–"], key="paste_cement")
                    water_cement_ratio = st.number_input("æ°´ç°æ¯”", min_value=0.1, max_value=1.0, value=0.29, step=0.01, key="paste_wc")
                
                with col_cond2:
                    admixture_dosage = st.number_input("å‡æ°´å‰‚æºé‡ (%)", min_value=0.0, max_value=5.0, value=0.18, step=0.01, key="paste_dosage")
                    temperature = st.number_input("ç¯å¢ƒæ¸©åº¦ (Â°C)", value=20.0, step=0.5, key="paste_temp")
        
        # æµåŠ¨åº¦æµ‹è¯•
        with st.expander("ğŸ“ æµåŠ¨åº¦æµ‹è¯•", expanded=True):
            col_flow1, col_flow2, col_flow3 = st.columns(3)
            
            with col_flow1:
                st.markdown("#### åˆå§‹æµåŠ¨åº¦")
                initial_diameter = st.number_input("åˆå§‹ç›´å¾„ (mm)", min_value=100, max_value=300, value=180, step=1, key="paste_initial_dia")
                initial_time = st.number_input("æµåŠ¨æ—¶é—´ (s)", min_value=0, max_value=300, value=5, step=1, key="paste_initial_time")
            
            with col_flow2:
                st.markdown("#### 30åˆ†é’ŸæµåŠ¨åº¦")
                flow_30min_dia = st.number_input("30åˆ†é’Ÿç›´å¾„ (mm)", min_value=100, max_value=300, value=175, step=1, key="paste_30min_dia")
                flow_30min_ret = st.number_input("ä¿æŒç‡ (%)", min_value=0.0, max_value=100.0, value=97.2, step=0.1, key="paste_30min_ret")
            
            with col_flow3:
                st.markdown("#### 60åˆ†é’ŸæµåŠ¨åº¦")
                flow_60min_dia = st.number_input("60åˆ†é’Ÿç›´å¾„ (mm)", min_value=100, max_value=300, value=170, step=1, key="paste_60min_dia")
                flow_60min_ret = st.number_input("ä¿æŒç‡ (%)", min_value=0.0, max_value=100.0, value=94.4, step=0.1, key="paste_60min_ret")
        
        # å‡ç»“æ—¶é—´
        with st.expander("â° å‡ç»“æ—¶é—´", expanded=False):
            col_set1, col_set2 = st.columns(2)
            with col_set1:
                initial_setting = st.number_input("åˆå‡æ—¶é—´ (min)", min_value=0, max_value=1000, value=240, step=5, key="paste_initial_set")
                final_setting = st.number_input("ç»ˆå‡æ—¶é—´ (min)", min_value=0, max_value=1500, value=360, step=5, key="paste_final_set")
        
        # å¤‡æ³¨å’Œä¿å­˜
        col_note, col_save = st.columns([3, 1])
        with col_note:
            notes = st.text_area("å®éªŒå¤‡æ³¨", height=100, placeholder="è®°å½•æµ†ä½“çŠ¶æ€ã€æ³Œæ°´æƒ…å†µã€å¼‚å¸¸ç°è±¡ç­‰", key="paste_notes")
        
        with col_save:
            st.markdown("<br>" * 4, unsafe_allow_html=True)
            if st.button("ğŸ’¾ ä¿å­˜å‡€æµ†å®éªŒæ•°æ®", type="primary", use_container_width=True, key="save_paste"):
                if selected_exp_id:
                    # æ„å»ºæ•°æ®è®°å½•
                    paste_data = {
                        "id": str(uuid.uuid4())[:8],
                        "experiment_id": selected_exp_id,
                        "record_date": record_date.strftime("%Y-%m-%d"),
                        "operator": operator,
                        "sample_id": sample_id,
                        
                        # å®éªŒæ¡ä»¶
                        "cement_type": cement_type,
                        "water_cement_ratio": water_cement_ratio,
                        "admixture_dosage": admixture_dosage,
                        "temperature": temperature,
                        
                        # æµåŠ¨åº¦æ•°æ®
                        "initial_diameter": initial_diameter,
                        "initial_time": initial_time,
                        "flow_30min_dia": flow_30min_dia,
                        "flow_30min_ret": flow_30min_ret,
                        "flow_60min_dia": flow_60min_dia,
                        "flow_60min_ret": flow_60min_ret,
                        
                        # å‡ç»“æ—¶é—´
                        "initial_setting": initial_setting,
                        "final_setting": final_setting,
                        
                        # å¤‡æ³¨
                        "notes": notes,
                        
                        # å…ƒæ•°æ®
                        "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "type": "paste"
                    }
                    
                    # ä¿å­˜åˆ°æ•°æ®ç®¡ç†å™¨
                    if "performance_data" not in data:
                        data["performance_data"] = {"paste": []}
                    
                    if "paste" not in data["performance_data"]:
                        data["performance_data"]["paste"] = []
                    
                    data["performance_data"]["paste"].append(paste_data)
                    
                    if data_manager.save_data(data):
                        st.success("âœ… å‡€æµ†å®éªŒæ•°æ®ä¿å­˜æˆåŠŸï¼")
                        time.sleep(1)
                        st.rerun()
                    else:
                        st.error("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")
                else:
                    st.error("è¯·é€‰æ‹©å®éªŒé¡¹ç›®")
    
    # 3. ç ‚æµ†å®éªŒæ•°æ®è®°å½•
    with tab3:
        st.subheader("ğŸ—ï¸ ç ‚æµ†å®éªŒæ•°æ®è®°å½•")
        
        # åˆ›å»ºä¸¤åˆ—å¸ƒå±€
        col1, col2 = st.columns([1, 1])
        
        with col1:
            # å®éªŒé€‰æ‹©
            exp_options = get_experiment_options("æ€§èƒ½æµ‹è¯•")
            if exp_options:
                selected_exp_key = st.selectbox(
                    "é€‰æ‹©å®éªŒé¡¹ç›®",
                    options=list(exp_options.keys()),
                    key="mortar_exp_select"
                )
                selected_exp_id = exp_options.get(selected_exp_key)
            else:
                st.warning("æš‚æ— æ€§èƒ½æµ‹è¯•å®éªŒé¡¹ç›®ï¼Œè¯·åœ¨å®éªŒç®¡ç†ä¸­åˆ›å»º")
                selected_exp_id = None
            
            # åŸºç¡€ä¿¡æ¯
            with st.container(border=True):
                st.markdown("### åŸºç¡€ä¿¡æ¯")
                record_date = st.date_input("è®°å½•æ—¥æœŸ", datetime.now(), key="mortar_date")
                operator = st.text_input("æ“ä½œäºº", value="å¾æ¢“é¦¨", key="mortar_operator")
                sample_id = st.text_input("æ ·å“ç¼–å·", placeholder="ä¾‹å¦‚: MORTAR-001", key="mortar_sample")
        
        with col2:
            # é…åˆæ¯”
            with st.container(border=True):
                st.markdown("### é…åˆæ¯”è®¾è®¡")
                col_mix1, col_mix2 = st.columns(2)
                with col_mix1:
                    cement_dosage = st.number_input("æ°´æ³¥ç”¨é‡ (g)", min_value=0, max_value=2000, value=450, step=5, key="mortar_cement")
                    sand_dosage = st.number_input("ç ‚ç”¨é‡ (g)", min_value=0, max_value=5000, value=1350, step=10, key="mortar_sand")
                
                with col_mix2:
                    water_dosage = st.number_input("æ°´ç”¨é‡ (g)", min_value=0, max_value=1000, value=225, step=5, key="mortar_water")
                    admixture_dosage = st.number_input("å‡æ°´å‰‚æºé‡ (%)", min_value=0.0, max_value=5.0, value=0.18, step=0.01, key="mortar_dosage")
        
        # æµåŠ¨åº¦å’Œå¼ºåº¦
        with st.expander("ğŸ“Š æ€§èƒ½æµ‹è¯•", expanded=True):
            col_perf1, col_perf2 = st.columns(2)
            
            with col_perf1:
                st.markdown("#### æµåŠ¨åº¦")
                mortar_flow = st.number_input("ç ‚æµ†æµåŠ¨åº¦ (mm)", min_value=100, max_value=300, value=180, step=1, key="mortar_flow")
                flow_retention = st.number_input("æµåŠ¨åº¦ä¿æŒç‡ (%)", min_value=0.0, max_value=100.0, value=95.0, step=0.1, key="mortar_flow_ret")
                
                st.markdown("#### ä¿æ°´æ€§")
                water_retention = st.number_input("ä¿æ°´æ€§ (%)", min_value=0.0, max_value=100.0, value=85.0, step=0.1, key="mortar_water_ret")
            
            with col_perf2:
                st.markdown("#### æŠ—å‹å¼ºåº¦ (MPa)")
                strength_1d = st.number_input("1å¤©å¼ºåº¦", min_value=0.0, max_value=100.0, value=15.0, step=0.1, key="mortar_strength_1d")
                strength_3d = st.number_input("3å¤©å¼ºåº¦", min_value=0.0, max_value=100.0, value=30.0, step=0.1, key="mortar_strength_3d")
                strength_7d = st.number_input("7å¤©å¼ºåº¦", min_value=0.0, max_value=100.0, value=45.0, step=0.1, key="mortar_strength_7d")
                strength_28d = st.number_input("28å¤©å¼ºåº¦", min_value=0.0, max_value=100.0, value=60.0, step=0.1, key="mortar_strength_28d")
        
        # å¤‡æ³¨å’Œä¿å­˜
        col_note, col_save = st.columns([3, 1])
        with col_note:
            notes = st.text_area("å®éªŒå¤‡æ³¨", height=100, placeholder="è®°å½•ç ‚æµ†çŠ¶æ€ã€æˆå‹æƒ…å†µã€å…»æŠ¤æ¡ä»¶ç­‰", key="mortar_notes")
        
        with col_save:
            st.markdown("<br>" * 4, unsafe_allow_html=True)
            if st.button("ğŸ’¾ ä¿å­˜ç ‚æµ†å®éªŒæ•°æ®", type="primary", use_container_width=True, key="save_mortar"):
                if selected_exp_id:
                    # æ„å»ºæ•°æ®è®°å½•
                    mortar_data = {
                        "id": str(uuid.uuid4())[:8],
                        "experiment_id": selected_exp_id,
                        "record_date": record_date.strftime("%Y-%m-%d"),
                        "operator": operator,
                        "sample_id": sample_id,
                        
                        # é…åˆæ¯”
                        "cement_dosage": cement_dosage,
                        "sand_dosage": sand_dosage,
                        "water_dosage": water_dosage,
                        "admixture_dosage": admixture_dosage,
                        
                        # æ€§èƒ½æµ‹è¯•
                        "mortar_flow": mortar_flow,
                        "flow_retention": flow_retention,
                        "water_retention": water_retention,
                        "strength_1d": strength_1d,
                        "strength_3d": strength_3d,
                        "strength_7d": strength_7d,
                        "strength_28d": strength_28d,
                        
                        # å¤‡æ³¨
                        "notes": notes,
                        
                        # å…ƒæ•°æ®
                        "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "type": "mortar"
                    }
                    
                    # ä¿å­˜åˆ°æ•°æ®ç®¡ç†å™¨
                    if "performance_data" not in data:
                        data["performance_data"] = {"mortar": []}
                    
                    if "mortar" not in data["performance_data"]:
                        data["performance_data"]["mortar"] = []
                    
                    data["performance_data"]["mortar"].append(mortar_data)
                    
                    if data_manager.save_data(data):
                        st.success("âœ… ç ‚æµ†å®éªŒæ•°æ®ä¿å­˜æˆåŠŸï¼")
                        time.sleep(1)
                        st.rerun()
                    else:
                        st.error("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")
                else:
                    st.error("è¯·é€‰æ‹©å®éªŒé¡¹ç›®")
    
    # 4. æ··å‡åœŸå®éªŒæ•°æ®è®°å½•
    with tab4:
        st.subheader("ğŸ¢ æ··å‡åœŸå®éªŒæ•°æ®è®°å½•")
        
        # åˆ›å»ºä¸¤åˆ—å¸ƒå±€
        col1, col2 = st.columns([1, 1])
        
        with col1:
            # å®éªŒé€‰æ‹©
            exp_options = get_experiment_options("æ€§èƒ½æµ‹è¯•")
            if exp_options:
                selected_exp_key = st.selectbox(
                    "é€‰æ‹©å®éªŒé¡¹ç›®",
                    options=list(exp_options.keys()),
                    key="concrete_exp_select"
                )
                selected_exp_id = exp_options.get(selected_exp_key)
            else:
                st.warning("æš‚æ— æ€§èƒ½æµ‹è¯•å®éªŒé¡¹ç›®ï¼Œè¯·åœ¨å®éªŒç®¡ç†ä¸­åˆ›å»º")
                selected_exp_id = None
            
            # åŸºç¡€ä¿¡æ¯
            with st.container(border=True):
                st.markdown("### åŸºç¡€ä¿¡æ¯")
                record_date = st.date_input("è®°å½•æ—¥æœŸ", datetime.now(), key="concrete_date")
                operator = st.text_input("æ“ä½œäºº", value="å¾æ¢“é¦¨", key="concrete_operator")
                mix_id = st.text_input("é…åˆæ¯”ç¼–å·", placeholder="ä¾‹å¦‚: MIX-C30-001", key="concrete_mix")
        
        with col2:
            # é…åˆæ¯”è®¾è®¡
            with st.container(border=True):
                st.markdown("### é…åˆæ¯”è®¾è®¡ (kg/mÂ³)")
                col_mix1, col_mix2 = st.columns(2)
                with col_mix1:
                    cement = st.number_input("æ°´æ³¥", min_value=0, max_value=1000, value=320, step=5, key="concrete_cement")
                    sand = st.number_input("ç ‚", min_value=0, max_value=2000, value=750, step=10, key="concrete_sand")
                    stone = st.number_input("çŸ³å­", min_value=0, max_value=2500, value=1050, step=10, key="concrete_stone")
                
                with col_mix2:
                    water = st.number_input("æ°´", min_value=0, max_value=300, value=160, step=5, key="concrete_water")
                    admixture = st.number_input("å‡æ°´å‰‚", min_value=0.0, max_value=10.0, value=3.2, step=0.1, key="concrete_admixture")
                    mineral_addition = st.number_input("çŸ¿ç‰©æºåˆæ–™", min_value=0, max_value=300, value=80, step=5, key="concrete_mineral")
        
        # æ–°æ‹Œæ··å‡åœŸæ€§èƒ½
        with st.expander("ğŸ¥„ æ–°æ‹Œæ··å‡åœŸæ€§èƒ½", expanded=True):
            col_fresh1, col_fresh2, col_fresh3 = st.columns(3)
            
            with col_fresh1:
                st.markdown("#### å·¥ä½œæ€§")
                slump = st.number_input("åè½åº¦ (mm)", min_value=0, max_value=300, value=180, step=5, key="concrete_slump")
                slump_flow = st.number_input("æ‰©å±•åº¦ (mm)", min_value=300, max_value=800, value=500, step=10, key="concrete_slump_flow")
            
            with col_fresh2:
                st.markdown("#### å«æ°”é‡ä¸å¯†åº¦")
                air_content = st.number_input("å«æ°”é‡ (%)", min_value=0.0, max_value=10.0, value=2.5, step=0.1, key="concrete_air")
                density = st.number_input("è¡¨è§‚å¯†åº¦ (kg/mÂ³)", min_value=2000, max_value=3000, value=2350, step=10, key="concrete_density")
            
            with col_fresh3:
                st.markdown("#### å‡ç»“æ—¶é—´")
                initial_setting = st.number_input("åˆå‡ (h)", min_value=0.0, max_value=24.0, value=4.5, step=0.5, key="concrete_initial_set")
                final_setting = st.number_input("ç»ˆå‡ (h)", min_value=0.0, max_value=36.0, value=7.5, step=0.5, key="concrete_final_set")
        
        # ç¡¬åŒ–æ··å‡åœŸæ€§èƒ½
        with st.expander("ğŸ’ª ç¡¬åŒ–æ··å‡åœŸæ€§èƒ½", expanded=True):
            col_hard1, col_hard2 = st.columns(2)
            
            with col_hard1:
                st.markdown("#### æŠ—å‹å¼ºåº¦ (MPa)")
                strength_3d = st.number_input("3å¤©å¼ºåº¦", min_value=0.0, max_value=100.0, value=20.0, step=0.1, key="concrete_strength_3d")
                strength_7d = st.number_input("7å¤©å¼ºåº¦", min_value=0.0, max_value=100.0, value=30.0, step=0.1, key="concrete_strength_7d")
                strength_28d = st.number_input("28å¤©å¼ºåº¦", min_value=0.0, max_value=100.0, value=45.0, step=0.1, key="concrete_strength_28d")
            
            with col_hard2:
                st.markdown("#### å…¶ä»–æ€§èƒ½")
                flexural_strength = st.number_input("æŠ—æŠ˜å¼ºåº¦ (MPa)", min_value=0.0, max_value=20.0, value=5.5, step=0.1, key="concrete_flexural")
                shrinkage = st.number_input("æ”¶ç¼©ç‡ (Ã—10â»â¶)", min_value=0, max_value=1000, value=350, step=10, key="concrete_shrinkage")
                carbonation = st.number_input("ç¢³åŒ–æ·±åº¦ (mm)", min_value=0.0, max_value=50.0, value=2.5, step=0.1, key="concrete_carbonation")
        
        # å¤‡æ³¨å’Œä¿å­˜
        col_note, col_save = st.columns([3, 1])
        with col_note:
            notes = st.text_area("å®éªŒå¤‡æ³¨", height=100, placeholder="è®°å½•æ··å‡åœŸçŠ¶æ€ã€æ–½å·¥æ€§èƒ½ã€å…»æŠ¤æ¡ä»¶ã€å¼‚å¸¸æƒ…å†µç­‰", key="concrete_notes")
        
        with col_save:
            st.markdown("<br>" * 4, unsafe_allow_html=True)
            if st.button("ğŸ’¾ ä¿å­˜æ··å‡åœŸå®éªŒæ•°æ®", type="primary", use_container_width=True, key="save_concrete"):
                if selected_exp_id:
                    # æ„å»ºæ•°æ®è®°å½•
                    concrete_data = {
                        "id": str(uuid.uuid4())[:8],
                        "experiment_id": selected_exp_id,
                        "record_date": record_date.strftime("%Y-%m-%d"),
                        "operator": operator,
                        "mix_id": mix_id,
                        
                        # é…åˆæ¯”è®¾è®¡
                        "cement": cement,
                        "sand": sand,
                        "stone": stone,
                        "water": water,
                        "admixture": admixture,
                        "mineral_addition": mineral_addition,
                        
                        # æ–°æ‹Œæ··å‡åœŸæ€§èƒ½
                        "slump": slump,
                        "slump_flow": slump_flow,
                        "air_content": air_content,
                        "density": density,
                        "initial_setting": initial_setting,
                        "final_setting": final_setting,
                        
                        # ç¡¬åŒ–æ··å‡åœŸæ€§èƒ½
                        "strength_3d": strength_3d,
                        "strength_7d": strength_7d,
                        "strength_28d": strength_28d,
                        "flexural_strength": flexural_strength,
                        "shrinkage": shrinkage,
                        "carbonation": carbonation,
                        
                        # å¤‡æ³¨
                        "notes": notes,
                        
                        # å…ƒæ•°æ®
                        "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "type": "concrete"
                    }
                    
                    # ä¿å­˜åˆ°æ•°æ®ç®¡ç†å™¨
                    if "performance_data" not in data:
                        data["performance_data"] = {"concrete": []}
                    
                    if "concrete" not in data["performance_data"]:
                        data["performance_data"]["concrete"] = []
                    
                    data["performance_data"]["concrete"].append(concrete_data)
                    
                    if data_manager.save_data(data):
                        st.success("âœ… æ··å‡åœŸå®éªŒæ•°æ®ä¿å­˜æˆåŠŸï¼")
                        time.sleep(1)
                        st.rerun()
                    else:
                        st.error("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")
                else:
                    st.error("è¯·é€‰æ‹©å®éªŒé¡¹ç›®")
    
    # æ•°æ®æŸ¥çœ‹æ¨¡å—
    st.divider()
    st.subheader("ğŸ“Š æ•°æ®æŸ¥çœ‹")
    
    # ä½¿ç”¨é€‰é¡¹å¡æŸ¥çœ‹ä¸åŒç±»å‹çš„æ•°æ®
    view_tab1, view_tab2, view_tab3, view_tab4 = st.tabs(["åˆæˆæ•°æ®", "å‡€æµ†æ•°æ®", "ç ‚æµ†æ•°æ®", "æ··å‡åœŸæ•°æ®"])
    
    with view_tab1:
        synthesis_data = data.get("performance_data", {}).get("synthesis", [])
        if synthesis_data:
            df = pd.DataFrame(synthesis_data)
            st.dataframe(df[["record_date", "batch_no", "water_reduction", "solid_content", "ph_value", "operator"]], use_container_width=True)
        else:
            st.info("æš‚æ— åˆæˆå®éªŒæ•°æ®")
    
    with view_tab2:
        paste_data = data.get("performance_data", {}).get("paste", [])
        if paste_data:
            df = pd.DataFrame(paste_data)
            st.dataframe(df[["record_date", "sample_id", "initial_diameter", "flow_30min_dia", "flow_60min_dia", "operator"]], use_container_width=True)
        else:
            st.info("æš‚æ— å‡€æµ†å®éªŒæ•°æ®")
    
    with view_tab3:
        mortar_data = data.get("performance_data", {}).get("mortar", [])
        if mortar_data:
            df = pd.DataFrame(mortar_data)
            st.dataframe(df[["record_date", "sample_id", "mortar_flow", "strength_3d", "strength_28d", "operator"]], use_container_width=True)
        else:
            st.info("æš‚æ— ç ‚æµ†å®éªŒæ•°æ®")
    
    with view_tab4:
        concrete_data = data.get("performance_data", {}).get("concrete", [])
        if concrete_data:
            df = pd.DataFrame(concrete_data)
            st.dataframe(df[["record_date", "mix_id", "slump", "slump_flow", "strength_28d", "operator"]], use_container_width=True)
        else:
            st.info("æš‚æ— æ··å‡åœŸå®éªŒæ•°æ®")
