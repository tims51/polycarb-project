import sys
import os
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„ï¼Œç¡®ä¿èƒ½å¯¼å…¥ app æ¨¡å—
project_root = Path(__file__).parent.parent.parent
sys.path.append(str(project_root))

from app.core.container import ServiceContainer
from app.utils.logger import logger

class DataDoctor:
    def __init__(self):
        # åˆå§‹åŒ–æœåŠ¡å®¹å™¨
        self.container = ServiceContainer()
        self.inventory_service = self.container.inventory_service
        self.data_service = self.container.data_service

    def scan_unit_anomalies(self):
        """æ‰«æå•ä½å¼‚å¸¸ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¨çº§æ•°æ®æ··å…¥ kg çº§å­˜å‚¨"""
        print("ğŸ” æ­£åœ¨æ‰«æå•ä½å¼‚å¸¸...")
        issues = []
        materials = self.data_service.get_all_raw_materials()
        
        for mat in materials:
            # é€»è¾‘ï¼šåŸææ–™å­˜ kgã€‚å¦‚æœåº“å­˜æ•° < 0.1 (ä¸”ä¸æ˜¯0)ï¼Œæå¤§æ¦‚ç‡æ˜¯è¯¯å­˜äº†å¨
            qty = float(mat.get("stock_quantity", 0))
            if 0 < qty < 0.1: 
                issues.append(f"   âš ï¸  [å•ä½ç–‘ä¼¼é”™è¯¯] åŸææ–™: {mat['name']} (ID: {mat['id']}), å½“å‰åº“å­˜: {qty} (ç–‘ä¼¼ä¸ºå¨)")
        
        if not issues:
            print("   âœ… å•ä½æ£€æŸ¥é€šè¿‡ã€‚")
        return issues

    def scan_orphan_records(self):
        """æ‰«æå­¤å„¿æ•°æ®ï¼šæ£€æŸ¥å°è´¦é‡Œçš„ material_id æ˜¯å¦å­˜åœ¨"""
        print("ğŸ” æ­£åœ¨æ‰«æå­¤å„¿æ•°æ®...")
        valid_ids = {m['id'] for m in self.data_service.get_all_raw_materials()}
        records = self.data_service._get_items("inventory_records")
        
        orphans = []
        for r in records:
            if r.get("material_id") not in valid_ids:
                orphans.append(f"   âš ï¸  [å­¤å„¿è®°å½•] è®°å½•ID: {r.get('id')}, å…³è”ç‰©æ–™ID: {r.get('material_id')} (å·²ä¸å­˜åœ¨)")
        
        if not orphans:
            print("   âœ… å…³è”å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡ã€‚")
        return orphans

    def run_full_diagnosis(self):
        print("\n=== ğŸ¥ Polycarb æ•°æ®å¥åº·è¯Šæ–­æŠ¥å‘Š ===")
        unit_issues = self.scan_unit_anomalies()
        orphan_issues = self.scan_orphan_records()
        print("======================================\n")
        
        if unit_issues or orphan_issues:
            print(f"âŒ å‘ç°æ½œåœ¨é—®é¢˜ (å…± {len(unit_issues) + len(orphan_issues)} é¡¹):")
            for i in unit_issues: print(i)
            for i in orphan_issues: print(i)
            print("\nğŸ’¡ å»ºè®®: è¯·è®© Trae ç¼–å†™ä¿®å¤è„šæœ¬å¤„ç†ä¸Šè¿° IDã€‚")
        else:
            print("âœ… ç³»ç»Ÿå¥åº·ï¼Œæœªå‘ç°å¼‚å¸¸ã€‚")

if __name__ == "__main__":
    try:
        doctor = DataDoctor()
        doctor.run_full_diagnosis()
    except Exception as e:
        print(f"âŒ è¯Šæ–­è¿è¡Œå¤±è´¥: {e}")